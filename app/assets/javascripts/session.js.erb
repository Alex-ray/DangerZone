var map = L.mapbox.map('map', 'alex-ray.map-p9i5ggnv');
map.current_location = {lat: 0, lon: 0};
var marker = L.marker([0,0],
                {icon: L.icon({
                    iconUrl: "http://i.imgur.com/FOqzufV.png",
                    iconSize:[35, 35],
                    iconAnchor:[25, 25],
                    popupAnchor:[0, -25]
                  })
              });
$(document).ready(function(){
  navigator.geolocation.requestCurrentPosition(map.showPosition, map.errorCallback, map.timeoutCallback, 5000);
  map.searchLocationFormInit();
  console.log('after get crimes function()');
});

map.searchLocationFormInit = function(){
  $('div.search img').click(function(){
    $('div.search').toggleClass('open');
  });

  $('form.location-search').on('submit', function(event){
    event.preventDefault();
    var data = $(this).serialize();

    $.getJSON('/geocoder?'+data, function(data){
      var pos = data.pos.split(" ");
      map.current_location.lon = pos[0];
      map.current_location.lat = pos[1];

      console.log(map.current_location.lat);
      console.log(map.current_location.lon);
      map.setView([map.current_location.lat, map.current_location.lon], 18);
      marker.setLatLng([map.current_location.lat, map.current_location.lon]).addTo(map);

      map.formClose();
    }, function(error){
      map.alertFlash(error.message);
    });

  });
}

map.flash = function(message, type){
  $('.flash').addClass(type).text(message);
  window.setTimeout(function(){
    $('.flash').removeClass(type);
  }, 4000);
}

map.formOpen = function(){
  $('div.search').addClass('open');
}

map.formClose = function(){
  $('div.search').removeClass('open');
}

map.timeoutCallback = function(){
  map.formOpen();
  map.flash("Enter your location!", "warning");
}

map.showPosition = function(pos) {
    map.current_location.lat = pos.coords.latitude;
    map.current_location.lon = pos.coords.longitude;
    console.log(map.current_location.lat);
    console.log(map.current_location.lon);
    map.getCrimes();

    map.setView([map.current_location.lat, map.current_location.lon], 18);
    marker.setLatLng([map.current_location.lat, map.current_location.lon]).addTo(map);
}

map.errorCallback = function(error){
  if(error.PERMISSION_DENIED){
    map.flash("Enable your Geo Location!", "alert");
  } else if(error.POSITION_UNAVAILABLE){
    map.flash("Enter a location!", "alert");
  } else if(error.TIMEOUT){
    map.flash("hmmm we timed out trying to find where you are hiding!", "alert");
  }
}

navigator.geolocation.requestCurrentPosition = function(successCB, errorCB, timeoutCB, timeoutThreshold){
  var successHandler = successCB;
  var errorHandler = errorCB;

  window.geolocationTimeoutHandler = function(){
    timeoutCB();
  }

  if (typeof(geolocationRequestTimeoutHandler) != 'undefined'){
    clearTimeout(window['geolocationRequestTimeoutHandler']);//clear any previous timers
  }

  var timeout = timeoutThreshold || 40000;//60 seconds
  window['geolocationRequestTimeoutHandler'] = setTimeout('geolocationTimeoutHandler()', timeout);//set timeout handler

  navigator.geolocation.watchPosition(
    function(position){
      clearTimeout(window['geolocationRequestTimeoutHandler']);
      successHandler(position);
    },
    function(error){
      clearTimeout(window['geolocationRequestTimeoutHandler']);
      errorHandler(error);
    },{enableHighAccuracy: true});
};

map.getCrimes = function(){
  console.log('crimes');
  console.log(map.current_location.lat);
  console.log(map.current_location.lon);
  $.getJSON('/crimes?distance=1000&location='+map.current_location.lat+' '+map.current_location.lon, function(data) {
    var crimes =  data;
    console.log("get json called to /crimes route");
    console.log(data);

    for (x in crimes){
      L.circle([crimes[x].latitude,crimes[x].longitude],10,{color:'red'},{opacity:'5.0'}).addTo(map);
    }
  });
}
