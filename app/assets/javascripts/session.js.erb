var app = {};
var map;

app.google_current_location = new google.maps.LatLng(-122.437, 37.765);
app.current_location = {lat: -122.437, lon: 37.765};


var mapOptions = {
  zoom: 18,
  center: app.google_current_location,
  mapTypeId: google.maps.MapTypeId.ROADMAP
}

map = new google.maps.Map(document.getElementById('map'),mapOptions);

app.geolocation = new google.maps.Marker({
  position: app.google_current_location,
  map: map,
  title: 'Your geolocation',
  icon: 'http://i.imgur.com/FOqzufV.png'
});


$(document).ready(function(){
  navigator.geolocation.requestCurrentPosition(app.showPosition, app.errorCallback, app.timeoutCallback, 5000);
  app.searchLocationFormInit();
  console.log('after get crimes function()');
});

app.searchLocationFormInit = function(){
  $('div.search img').click(function(){
    $('div.search').toggleClass('open');
  });

  $('form.location-search').on('submit', function(event){
    event.preventDefault();
    var data = $(this).serialize();

    $.getJSON('/geocoder?'+data, function(data){
      var pos = data.pos.split(" ");

      app.google_current_location = new google.maps.LatLng(pos[0], pos[1]);
      app.current_location = {lat: pos[0], lon: pos[1]};

      map.center(app.current_location);

      app.formClose();
    }, function(error){
      app.alertFlash(error.message);
    });

  });
}

app.flash = function(message, type){
  $('.flash').addClass(type).text(message);

  window.setTimeout(function(){
    $('.flash').removeClass(type);
  }, 4000);

}

app.formOpen = function(){
  $('div.search').addClass('open');
}

app.formClose = function(){
  $('div.search').removeClass('open');
}

app.timeoutCallback = function(){
  app.formOpen();
  app.flash("Enter your location!", "warning");
}

app.showPosition = function(pos) {
    app.getCrimes(5);
    app.google_current_location = new google.maps.LatLng(pos.coords.latitude ,pos.coords.longitude);
    app.current_location.lat = pos.coords.latitude;
    app.current_location.lon = pos.coords.longitude;

    map.setCenter(app.google_current_location);

    app.geolocation.setPosition(app.google_current_location);
}

app.errorCallback = function(error){
  if(error.PERMISSION_DENIED){
    app.flash("Enable your Geo Location!", "alert");
  } else if(error.POSITION_UNAVAILABLE){
    app.flash("Enter a location!", "alert");
  } else if(error.TIMEOUT){
    app.flash("hmmm we timed out trying to find where you are hiding!", "alert");
  }
}

navigator.geolocation.requestCurrentPosition = function(successCB, errorCB, timeoutCB, timeoutThreshold){
  var successHandler = successCB;
  var errorHandler = errorCB;

  window.geolocationTimeoutHandler = function(){
    timeoutCB();
  }

  if (typeof(geolocationRequestTimeoutHandler) != 'undefined'){
    clearTimeout(window['geolocationRequestTimeoutHandler']);//clear any previous timers
  }

  var timeout = timeoutThreshold || 40000;//60 seconds
  window['geolocationRequestTimeoutHandler'] = setTimeout('geolocationTimeoutHandler()', timeout);//set timeout handler

  navigator.geolocation.watchPosition(
    function(position){
      clearTimeout(window['geolocationRequestTimeoutHandler']);
      successHandler(position);
    },
    function(error){
      clearTimeout(window['geolocationRequestTimeoutHandler']);
      errorHandler(error);
    },{enableHighAccuracy: true});
};

app.getCrimes = function(distance){
  console.log(app.current_location);

  $.getJSON('/crimes?distance='+distance+'&location='+app.current_location.lon+', '+app.current_location.lat, function(data) {
    var crimes =  data;
    var heatMapData = [];
    console.log(crimes)

    for (x in crimes){
      if (crimes[x].safety_score == "2"){
        heatMapData.push({location: new google.maps.LatLng(crimes[x].latitude, crimes[x].longitude), weight: 3});
      } else if (crimes[x].safety_score == "1"){
        heatMapData.push({location: new google.maps.LatLng(crimes[x].latitude, crimes[x].longitude), weight: 1});
      }
    }
    console.log(heatMapData);

    var heatmap = new google.maps.visualization.HeatmapLayer({data: heatMapData});
    console.log(heatmap );
    console.log(map);
    heatmap.setMap(map);
    var gradient = [
       'rgba(255, 255, 80, 0)',
       'rgba(255, 255, 60, 1)',
       'rgba(200, 180, 25, 1)',
       'rgba(136, 76, 10, 1)',
       'rgba(63, 32, 0, 1)',
       'rgba(63, 0, 91, 1)',
       'rgba(127, 0, 63, 1)',
       'rgba(191, 0, 31, 1)',
       'rgba(255, 0, 0, 1)'
     ]

    heatmap.setOptions({gradient: gradient, radius: 15, opacity: 0.9, maxIntensity: 80 });

  });
}
